<!DOCTYPE html>
<html lang=" en ">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>End to end rest API typing</title>
  <meta name="description" content="A lot of apps use Typescript / JavaScript + Flow for frontend and backend code but I haven’t seen apps take advantage of this to create rest APIs that are st...">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="canonical" href="https://shahmeer.co/blog/end-to-api-typing.html">

  <script type="text/javascript" src="/assets/js/main.js"></script>
</head>


<body>

  <header class="header" role="banner">

  <div class="wrapper site-nav-wrapper">
    <div class="site-nav_logo"><a href="/"><?xml version="1.0" encoding="UTF-8"?>
<svg viewBox="0 0 300 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 41.2 (35397) - http://www.bohemiancoding.com/sketch -->
    <title>Untitled</title>
    <desc>Created with Sketch.</desc>
    <defs></defs>
    <g class="logo" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <path d="M184.809173,81.5864678 L185.541299,69.9568299 C185.541299,69.9568299 185.548707,67.1778728 187.911773,69.6901516 C190.274839,72.2024305 257.717314,133.2967 259.424944,134.919745 C261.132574,136.542789 262.130883,137.566128 262.130883,140.232911 C262.130883,144.834916 261.895865,152.967311 261.895865,154.785299 C261.895865,155.4524 261.232612,155.821597 260.530819,155.282872 C259.829026,154.744148 257.820053,152.870846 257.820053,152.870846 C257.820053,152.870846 188.729599,90.672118 187.709805,89.7353739 C186.690011,88.7986297 185.284875,87.5030455 184.958069,85.9426009 C184.631264,84.3821563 184.809173,81.5864678 184.809173,81.5864678 Z" class="animated-logo_upper" fill="#FFFFFF"></path>
        <path d="M219.048339,223.947705 L219.780464,212.318068 C219.780464,212.318068 219.787872,209.53911 222.150938,212.051389 C224.514004,214.563668 291.956479,275.657938 293.664109,277.280983 C295.371739,278.904027 296.370048,279.927365 296.370048,282.594148 C296.370048,287.196153 296.13503,295.328549 296.13503,297.146536 C296.13503,297.813638 295.471778,298.182835 294.769984,297.64411 C294.068191,297.105385 292.059218,295.232083 292.059218,295.232083 C292.059218,295.232083 222.968765,233.033356 221.94897,232.096612 C220.929176,231.159867 219.52404,229.864283 219.197235,228.303839 C218.870429,226.743394 219.048339,223.947705 219.048339,223.947705 Z" class="animated-logo_lower" fill="#FFFFFF"></path>
        <path d="M184.048339,136.947705 L184.780464,125.318068 C184.780464,125.318068 184.787872,122.53911 187.150938,125.051389 C187.675151,125.608702 191.401989,129.048897 196.903386,134.083214 C211.046582,147.025624 272.132084,202.708359 285.467523,214.824972 C290.327948,219.241166 293.523049,222.148057 293.877998,222.485425 C295.585628,224.10847 296.583937,225.131808 296.583937,227.798591 C296.583937,232.400596 296.348919,240.532991 296.348919,242.350979 C296.348919,243.01808 295.685666,243.387277 294.983873,242.848552 C294.28208,242.309828 292.273107,240.436526 292.273107,240.436526 C292.273107,240.436526 287.545004,236.180048 280.544267,229.877295 C265.293625,216.147166 204.044141,160.501847 192.608014,150.199109 C189.226022,147.152293 187.120834,145.254479 186.94897,145.096612 C185.929176,144.159867 184.52404,142.864283 184.197235,141.303839 C183.870429,139.743394 184.048339,136.947705 184.048339,136.947705 Z" class="animated-logo_middle" fill="#FFFFFF"></path>
    </g>
</svg>
</a></div>
    <nav class="site-nav">
      <a class="site-nav_page-link" target="_blank" href="https://github.com/shamwow">GitHub</a>
      <a class="site-nav_page-link" target="_blank" href="https://ca.linkedin.com/pub/shahmeer-navid/41/a16/6b4">LinkedIn</a>
      <a class="site-nav_page-link" target="_blank" href="mailto:shahmeernavid@gmail.com">Email</a>
      <a class="site-nav_page-link" target="_blank" href="/assets/resume.pdf">Resume</a>
    </nav>
  </div>

</header>


  <main class="page-content">
    <div class="wrapper">
      <div class="about-header-wrapper">
        <div class="about-header">
          <a href="/">
            <div class="about-header_main-logo"><?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg viewBox="0 0 115 240" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sketch="http://www.bohemiancoding.com/sketch/ns">
    <g class="logo" sketch:type="MSLayerGroup" fill-opacity="1.0" fill="#FFFFFF" fill-rule="evenodd">
        <path d="M3.794,0.876 C2.137,-0.626 1.173,-0.13 1.124,1.856 C1.022,5.994 0.85,12.934 0.764,16.399 C0.732,17.692 1.096,18.85 1.81,19.498 C9.935,26.863 61.838,72.95 75.526,85.357 C77.682,87.312 77.874,86.681 77.896,84.211 C77.934,79.804 77.991,73.101 78.018,69.938 C78.027,68.838 77.522,67.704 76.585,66.854 C67.289,58.427 15.964,11.906 3.794,0.876 Z" class="logo_upper" sketch:type="MSShapeGroup"></path>
        <path d="M111.099,209.105 C101.802,200.678 50.477,154.157 38.308,143.126 C36.651,141.624 35.687,142.12 35.638,144.106 C35.536,148.243 35.364,155.183 35.278,158.649 C35.246,159.942 35.61,161.1 36.324,161.748 C44.449,169.113 95.294,215.2 108.983,227.607 C111.139,229.562 112.388,228.931 112.41,226.461 C112.447,222.054 112.505,215.351 112.532,212.188 C112.541,211.089 112.036,209.955 111.099,209.105 L111.099,209.105 Z" class="logo_lower" sketch:type="MSShapeGroup"></path>
        <path d="M111.099,153.841 C101.802,145.414 15.964,67.238 3.794,56.208 C2.137,54.706 1.172,55.203 1.124,57.188 C1.021,61.326 0.85,68.265 0.764,71.731 C0.732,73.024 1.096,74.182 1.81,74.829 C9.935,82.194 95.294,159.935 108.983,172.343 C111.139,174.298 112.388,173.667 112.409,171.197 C112.447,166.79 112.504,160.087 112.531,156.924 C112.541,155.825 112.036,154.691 111.099,153.841 L111.099,153.841 Z" class="logo_middle" sketch:type="MSShapeGroup"></path>
    </g>
</svg>
</div>
            <div class="about-header_slogan">
              <h3 class="about-header_slogan_title">My name is Shahmeer</h3>
              <span class="about-header_slogan_subtitle">I make things</span>
            </div>
          </a>
        </div>
      </div>
      <div class="post">
  
    <div class="post_header-image" style="background-image: url('/assets/img/post_headers/end_to_end_api_typing.svg')"></div>
  

  <div class="post_content">
    <div class="post_meta">
      <h2 class="post_meta_title">End to end rest API typing</h2>

      <span class="post_meta_date">Aug 5, 2018</span>
    </div>

    <p>A lot of apps use Typescript / JavaScript + Flow for frontend and backend code but I haven’t seen apps take advantage of this to create rest APIs that are statically typed end to end. I decided to set up what was needed to get a fully typed API on top of express. It’s worked pretty well for some personal projects so I’m sharing it here.</p>

<!-- read more -->

<p>For posterity, at the time of writing I’m using Typescript v3.0.1 and Express v4.16.3.</p>

<p>There are two main files in my backend setup. The first contains my API definition and looks something like this:</p>

<figure class="highlight"><pre><code class="language-ts" data-lang="ts"><span></span><span class="kr">export</span> <span class="kr">interface</span> <span class="nx">RouteDef</span> <span class="p">{</span>
  <span class="nx">body</span>: <span class="kt">any</span><span class="p">;</span>
  <span class="nx">params</span>: <span class="kt">any</span><span class="p">;</span>
  <span class="nx">query</span>: <span class="kt">any</span><span class="p">;</span>
  <span class="nx">response</span>: <span class="kt">any</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">MethodDef</span> <span class="p">{</span>
  <span class="p">[</span><span class="nx">path</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">RouteDef</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">ApiDefBase</span> <span class="p">{</span>
  <span class="nx">GET</span>: <span class="kt">MethodDef</span><span class="p">;</span>
  <span class="nx">POST</span>: <span class="kt">MethodDef</span><span class="p">;</span>
  <span class="nx">PUT</span>: <span class="kt">MethodDef</span><span class="p">;</span>
  <span class="nx">DELETE</span>: <span class="kt">MethodDef</span><span class="p">;</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">interface</span> <span class="nx">AppApiDef</span> <span class="kr">extends</span> <span class="nx">ApiDefBase</span> <span class="p">{</span>
  <span class="nx">GET</span><span class="o">:</span> <span class="p">{</span>
    <span class="s1">&#39;/api/sample&#39;</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">body</span>: <span class="kt">void</span><span class="p">;</span>
      <span class="nx">params</span>: <span class="kt">void</span><span class="p">;</span>
      <span class="nx">query</span><span class="o">:</span> <span class="p">{</span> <span class="nx">count</span>: <span class="kt">number</span> <span class="p">};</span>
      <span class="nx">response</span><span class="o">:</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">200</span><span class="p">;</span> <span class="nx">data</span><span class="o">:</span> <span class="p">{</span> <span class="nx">message</span><span class="o">:</span> <span class="s1">&#39;Success&#39;</span> <span class="p">}</span> <span class="p">};</span>
    <span class="p">};</span>
  <span class="p">};</span>
  <span class="nx">POST</span><span class="o">:</span> <span class="p">{};</span>
  <span class="nx">PUT</span><span class="o">:</span> <span class="p">{};</span>
  <span class="nx">DELETE</span><span class="o">:</span> <span class="p">{};</span>
<span class="p">}</span></code></pre></figure>

<p>For each API route you can define the type of the <code>body</code> and <code>query</code> parameters and what the response should look like. My responses are typed as objects with a <code>data</code> and <code>status</code> property but you could also extend it to include whatever you want - for example, a <code>header</code> property.</p>

<p>Express also allows you to specify parameters in your routes. So <code>/api/share/:id</code> would match routes like <code>/api/share/123456</code> where <code>123456</code> would be made available via the <code>id</code> property on the Express request object. When the route is <code>/api/share/:id</code>, the <code>params</code> property for the route should be <code>{id: string}</code>. Ideally there should be something complaining if the route and params property are inconsistent in the API definition but Typescript doesn’t parse strings when type checking so it’s something that we’ll have to live with.</p>

<p>This API definition is used by the second main file, a custom router:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="c1">// Middlware for identifying routes that are authenticated. AuthenticatedMiddleware</span>
<span class="c1">// requires the user to be logged in and exposes the user object for that user. If not, the </span>
<span class="c1">// route will return a 404. PopulateUserMiddleware just exposes the user object of </span>
<span class="c1">// the logged in user if possible.</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">AuthenticatedMiddleware</span><span class="p">,</span> <span class="nx">PopulateUserMiddleware</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
<span class="c1">// Type for express middlware.</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">Middleware</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
 
<span class="nx">type</span> <span class="nx">HttpMethod</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span> <span class="o">|</span> <span class="s1">&#39;PUT&#39;</span> <span class="o">|</span> <span class="s1">&#39;POST&#39;</span> <span class="o">|</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">;</span>

<span class="nx">type</span> <span class="nx">Handler</span><span class="o">&lt;</span>
  <span class="nx">Def</span> <span class="kr">extends</span> <span class="p">{</span> <span class="p">[</span><span class="nx">_</span>: <span class="kt">string</span><span class="p">]</span><span class="o">:</span> <span class="nx">any</span> <span class="p">},</span>
  <span class="nx">Auth</span> <span class="kr">extends</span> <span class="s1">&#39;authenticated&#39;</span> <span class="o">|</span> <span class="s1">&#39;populate&#39;</span> <span class="o">|</span> <span class="s1">&#39;no&#39;</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
<span class="o">&gt;</span> <span class="o">=</span> <span class="p">(</span>
  <span class="nx">input</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">body</span>: <span class="kt">Def</span><span class="p">[</span><span class="s1">&#39;body&#39;</span><span class="p">];</span>
    <span class="nx">params</span>: <span class="kt">Def</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">];</span>
    <span class="nx">query</span>: <span class="kt">Def</span><span class="p">[</span><span class="s1">&#39;query&#39;</span><span class="p">];</span>
    <span class="nx">user</span>: <span class="kt">Auth</span> <span class="kr">extends</span> <span class="s1">&#39;authenticated&#39;</span>
      <span class="o">?</span> <span class="nx">User</span>
      : <span class="kt">Auth</span> <span class="kr">extends</span> <span class="s1">&#39;populate&#39;</span> <span class="o">?</span> <span class="nx">User</span> <span class="o">|</span> <span class="k">void</span> <span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="p">},</span>
  <span class="nx">req</span>: <span class="kt">Request</span><span class="p">,</span>
  <span class="nx">res</span>: <span class="kt">Response</span><span class="p">,</span>
<span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">Promise</span><span class="o">&lt;</span><span class="nx">Def</span><span class="p">[</span><span class="s1">&#39;response&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">;</span>

<span class="kr">interface</span> <span class="nx">RouterMethod</span><span class="o">&lt;</span><span class="nx">Method</span> <span class="kr">extends</span> <span class="nx">HttpMethod</span><span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// I wanted to keep route definitions the same as they would be with </span>
  <span class="c1">//vanilla express but also wanted to be able to type whether or not the user </span>
  <span class="c1">// object is defined. The multiple definitions here are to support the </span>
  <span class="c1">// arbitrary number of middleware that express allows in route definitions </span>
  <span class="c1">// while still typing authenticated routes properly.</span>

  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">authMiddleware</span>: <span class="kt">AuthenticatedMiddleware</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">],</span> <span class="s1">&#39;authenticated&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">populateMiddleware</span>: <span class="kt">PopulateUserMiddleware</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">],</span> <span class="s1">&#39;populate&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>

  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">middlewareOne</span>: <span class="kt">Middleware</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">authMiddleware</span>: <span class="kt">AuthenticatedMiddleware</span><span class="p">,</span>
    <span class="nx">middlewareOne</span>: <span class="kt">Middleware</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">],</span> <span class="s1">&#39;authenticated&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">middlewareOne</span>: <span class="kt">Middleware</span><span class="p">,</span>
    <span class="nx">authMiddleware</span>: <span class="kt">AuthenticatedMiddleware</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">],</span> <span class="s1">&#39;authenticated&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">populateMiddleware</span>: <span class="kt">PopulateUserMiddleware</span><span class="p">,</span>
    <span class="nx">middlewareOne</span>: <span class="kt">Middleware</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">],</span> <span class="s1">&#39;populate&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  <span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
    <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
    <span class="nx">middlewareOne</span>: <span class="kt">Middleware</span><span class="p">,</span>
    <span class="nx">populateMiddleware</span>: <span class="kt">PopulateUserMiddleware</span><span class="p">,</span>
    <span class="nx">handler</span>: <span class="kt">Handler</span><span class="o">&lt;</span><span class="nx">AppApiDef</span><span class="p">[</span><span class="nx">Method</span><span class="p">][</span><span class="nx">Path</span><span class="p">],</span> <span class="s1">&#39;populate&#39;</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="p">)</span><span class="o">:</span> <span class="k">void</span><span class="p">;</span>
  
  <span class="c1">// More definitions like the ones above to support more middleware.</span>
<span class="p">}</span>

<span class="kr">export</span> <span class="kr">class</span> <span class="nx">Router</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">readonly</span> <span class="nx">router</span>: <span class="kt">ExpressRouter</span><span class="p">;</span>

  <span class="kr">constructor</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span> <span class="o">=</span> <span class="nx">express</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="nx">use</span><span class="p">(</span><span class="nx">router</span>: <span class="kt">Router</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">router</span><span class="p">.</span><span class="nx">expressRouter</span><span class="p">());</span>
  <span class="p">}</span>

  <span class="c1">// In case I need to original express router.</span>
  <span class="nx">expressRouter</span><span class="p">()</span><span class="o">:</span> <span class="nx">ExpressRouter</span> <span class="p">{</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">_createRouteMethod</span><span class="p">(</span><span class="nx">method</span><span class="o">:</span> <span class="s1">&#39;get&#39;</span> <span class="o">|</span> <span class="s1">&#39;post&#39;</span> <span class="o">|</span> <span class="s1">&#39;put&#39;</span> <span class="o">|</span> <span class="s1">&#39;delete&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="nx">path</span>: <span class="kt">string</span><span class="p">,</span> <span class="p">...</span><span class="nx">middlewareAndHandler</span>: <span class="kt">Function</span><span class="p">[])</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// `nullx` throws an error if the argument is null - since </span>
      <span class="c1">// `middlewareAndHandler.pop()` can be undefined.</span>
      <span class="kr">const</span> <span class="nx">handler</span> <span class="o">=</span> <span class="nx">nullx</span><span class="p">(</span><span class="nx">middlewareAndHandler</span><span class="p">.</span><span class="nx">pop</span><span class="p">());</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">router</span><span class="p">[</span><span class="nx">method</span><span class="p">](</span>
        <span class="nx">path</span><span class="p">.</span><span class="nx">toString</span><span class="p">(),</span>
        <span class="p">...(</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="nx">middlewareAndHandler</span><span class="p">),</span>
        <span class="c1">// AsyncFunc just wraps the async function passed in to return a 500 </span>
        <span class="c1">// error code if something goes wrong.</span>
        <span class="nx">AsyncFunc</span><span class="p">(</span><span class="nx">async</span> <span class="kd">function</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="p">{</span>
          <span class="kr">const</span> <span class="p">{</span> <span class="nx">status</span><span class="p">,</span> <span class="nx">data</span> <span class="p">}</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="nx">await</span> <span class="nx">handler</span><span class="p">(</span>
            <span class="p">{</span>
              <span class="nx">query</span>: <span class="kt">req.query</span><span class="p">,</span>
              <span class="nx">params</span>: <span class="kt">req.params</span><span class="p">,</span>
              <span class="nx">body</span>: <span class="kt">req.body</span><span class="p">,</span>
              <span class="nx">user</span>: <span class="kt">req.user</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1">// Pass in original Express request and response objects in case I </span>
            <span class="c1">// need them.</span>
            <span class="nx">req</span><span class="p">,</span>
            <span class="nx">res</span><span class="p">,</span>
          <span class="p">);</span>
          <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="nx">status</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
        <span class="p">}),</span>
      <span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">get</span>: <span class="kt">RouterMethod</span><span class="o">&lt;</span><span class="s1">&#39;GET&#39;</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_createRouteMethod</span><span class="p">(</span><span class="s1">&#39;get&#39;</span><span class="p">);</span>
  <span class="nx">put</span>: <span class="kt">RouterMethod</span><span class="o">&lt;</span><span class="s1">&#39;PUT&#39;</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_createRouteMethod</span><span class="p">(</span><span class="s1">&#39;put&#39;</span><span class="p">);</span>
  <span class="nx">post</span>: <span class="kt">RouterMethod</span><span class="o">&lt;</span><span class="s1">&#39;POST&#39;</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_createRouteMethod</span><span class="p">(</span><span class="s1">&#39;post&#39;</span><span class="p">);</span>
  <span class="k">delete</span><span class="o">:</span> <span class="nx">RouterMethod</span><span class="o">&lt;</span><span class="s1">&#39;DELETE&#39;</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">_createRouteMethod</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">);</span>
<span class="p">}</span></code></pre></figure>

<p>The results (shown with visual studio code), trying an invalid route:
<img src="/assets/img/end_to_end_api_typing/incorrect_route.png" alt="Incorrect route" /></p>

<p>Trying an incorrect status:
<img src="/assets/img/end_to_end_api_typing/incorrect_status.png" alt="Incorrect status" /></p>

<p>Trying incorrect data:
<img src="/assets/img/end_to_end_api_typing/incorrect_data.png" alt="Incorrect response data" /></p>

<p>Trying a correct route:
<img src="/assets/img/end_to_end_api_typing/correct.png" alt="Correct" /></p>

<p>A route that requires the user to be logged in makes the user available to the handler:
<img src="/assets/img/end_to_end_api_typing/authenticated_route.png" alt="Authenticated route" /></p>

<p>The frontend setup has 1 file that looks something like:</p>

<figure class="highlight"><pre><code class="language-typescript" data-lang="typescript"><span></span><span class="c1">// Imported as fetch.js</span>

<span class="kr">const</span> <span class="nx">get</span> <span class="o">=</span> <span class="nx">async</span> <span class="kd">function</span><span class="o">&lt;</span><span class="nx">Path</span> <span class="kr">extends</span> <span class="nx">keyof</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="p">(</span>
  <span class="nx">path</span>: <span class="kt">Path</span><span class="p">,</span>
  <span class="nx">queryParams</span>: <span class="kt">AppApiDef</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">][</span><span class="nx">Path</span><span class="p">][</span><span class="s1">&#39;query&#39;</span><span class="p">],</span>
<span class="p">)</span><span class="o">:</span> <span class="nx">Promise</span><span class="o">&lt;</span>
  <span class="o">|</span> <span class="nx">AppApiDef</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">][</span><span class="nx">Path</span><span class="p">][</span><span class="s1">&#39;response&#39;</span><span class="p">]</span>
  <span class="c1">// The result could also be one of these and we should handle the error cases.</span>
  <span class="c1">// Even though the url for the API request is statically checked for, this 404 </span>
  <span class="c1">// needs to be included because authenticated routes can return a 404 (see above). </span>
  <span class="c1">// We could avoid this by explicitly passing in a user object to this method </span>
  <span class="c1">// but it hasn&#39;t been a source of errors for me so I haven&#39;t bothered.</span>
  <span class="o">|</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">404</span><span class="p">;</span> <span class="nx">data</span>: <span class="kt">void</span> <span class="p">}</span>
  <span class="o">|</span> <span class="p">{</span> <span class="nx">status</span>: <span class="kt">500</span><span class="p">;</span> <span class="nx">data</span>: <span class="kt">void</span> <span class="p">}</span>
<span class="o">&gt;</span> <span class="p">{</span>
  <span class="c1">// Make request, return response.</span>
<span class="p">}</span>

<span class="c1">// Other methods for other HTTP methods.</span>

<span class="kr">export</span> <span class="k">default</span> <span class="p">{</span> <span class="nx">get</span> <span class="p">};</span></code></pre></figure>

<p>And the result when making an API request in frontend code:</p>

<p><img src="/assets/img/end_to_end_api_typing/end_result.png" alt="End result" /></p>


  </div>

</div>

    </div>
  </main>


  <script type="text/javascript">
    (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date(); a = s.createElement(o),
      m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
    })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-47433213-1', 'auto');
    ga('send', 'pageview');
  </script>
</body>

</html>
